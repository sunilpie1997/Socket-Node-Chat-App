<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <title>chat app</title>
  </head>
  <body>

    <div class="container">
        <div class="container-fluid">
          <h1>Let's chat</h1>
         
          <div class="jumbotron jumbotron-fluid">
            <div class="container">
              <p class="lead" id="para"></p>
            </div>
          </div>

          <form class="form-group" id='form'>
            <input type="text" class="form-control" placeholder="enter your name" id="m"><button type="submit" class="btn btn-primary">Send</button>

        </form>
          <div class="card-deck">
            <div class="card text-white bg-primary mb-3">
              <div id="name" class="card-header">
                
              </div>
              <div class="card-body" id="client">

              </div>
            </div>
           
            <div class="card text-white bg-dark mb-3">
              <div class="card-header">
                Server
              </div>
              <div class="card-body" id="server">

              </div>
            </div>
          </div> 


          
           
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
    <script>
      var socket = io();
    

    $(function () {
      var is_first=true;
      
      /*  initially it is true,but after first message is sent,it becomes false  */
      
      var username=null;
      const socket = io();

      //when user clicks on input element
      $('#m').on('focus',()=>{
        if(username!==null) {
          /* checks if user has sent his first message with username  */

          socket.emit("is_typing",{"username":`${username}`,"value":true});
        }
      })


/*  when input element fades->user has clicked outside input element in form */

      $('#m').on('blur',()=>{
        if(username!==null){
        socket.emit("is_typing",{"username":`${username}`,"value":false});
        }
      })


/*  receiving message from server with custom event->'message'  */

      socket.on("message",(msg)=>{
        console.log("returned")
          $('#server').prepend($('<p class="card-text">').text(msg))
      });
      
/*   receiving typing message  */

      socket.on('extra',(msg)=>{
        if(msg!==null){
          $('#para').html(`${msg}`);
        }
        else
        {
          $('#para').html("");
        }
      })


/*   when user clicks send    */

      $('form').submit(function(e) {
        e.preventDefault(); // prevents page reloading
        if(is_first)
        /*  checks if user is sending message  for first time ...it will be used as username */
        {
        username=$('#m').val();
        /*   add user event is generated by client */
        socket.emit('add_user',username);
        $('#name').html(username);
        is_first=false;//setting false

        $('#m').attr('placeholder',"enter message")


        }
        else{
        socket.emit('message', $('#m').val());
        $('#client').prepend($('<p class="card-text">').text($('#m').val()))
        }
        $('#m').val('');
        return false;
      });
    });
    
  </script>
  </body>
</html>